<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tran.pulse.user.mapper.SysPermissionMapper">

    <!-- ========= 公共列 ========= -->
    <sql id="Base_Column_List">
        id, code, name, resource, action, resource_type, parent_id, path,
        method, sort_order, status, is_deleted, description,
        created_by, updated_by, create_time, update_time
    </sql>


    <!-- ========= 结果映射 ========= -->
    <resultMap id="BaseResultMap" type="com.tran.pulse.common.domain.entity.SysPermission">
        <id     column="id"            property="id"/>
        <result column="code"          property="code"/>
        <result column="name"          property="name"/>
        <result column="resource"      property="resource"/>
        <result column="action"        property="action"/>
        <result column="resource_type" property="resourceType"/>
        <result column="parent_id"     property="parentId"/>
        <result column="path"          property="path"/>
        <result column="method"        property="method"/>
        <result column="sort_order"    property="sortOrder"/>
        <result column="status"        property="status"/>
        <result column="is_deleted"    property="isDeleted"/>
        <result column="description"   property="description"/>
        <result column="created_by"    property="createdBy"/>
        <result column="updated_by"    property="updatedBy"/>
        <result column="create_time"   property="createTime"/>
        <result column="update_time"   property="updateTime"/>
    </resultMap>

    <select id="getPermissionsByUserId"
            resultMap="BaseResultMap">
        SELECT DISTINCT
            p.id,
            p.code,
            p.name,
            p.resource,
            p.action,
            p.resource_type,
            p.parent_id,
            p.path,
            p.method,
            p.sort_order,
            p.status,
            p.description,
            p.create_time,
            p.update_time
        FROM sys_permissions p
                 INNER JOIN sys_role_permissions rp ON p.id = rp.permission_id AND rp.is_active = 1
                 INNER JOIN sys_roles r ON rp.role_id = r.id AND r.status = 1 AND r.is_deleted = 0
                 INNER JOIN sys_user_roles ur ON r.id = ur.role_id AND ur.is_active = 1
                 INNER JOIN sys_user u ON ur.user_id = u.id AND u.status = '1000' AND u.is_deleted = 0
        WHERE u.id = ${userId}
          AND p.status = 1
          AND p.is_deleted = 0
          AND (ur.expire_time IS NULL OR ur.expire_time > NOW())
        ORDER BY p.resource, p.action
    </select>

</mapper>
